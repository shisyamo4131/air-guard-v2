rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions (Optional, but good for clarity) ---
    function isAuthenticated() {
      return request.auth != null;
    }

    function userCompanyId() {
      // request.auth.token.companyId がカスタムクレームに設定されていることを前提とします
      return request.auth.token.companyId;
    }

    function isSuperUser() {
      // isSuperUserがtrueの場合のみスーパーユーザーと判定
      return request.auth != null
        && "isSuperUser" in request.auth.token
        && request.auth.token.isSuperUser == true;
    }

    // --- Rules for 'System' collection ---
    // System コレクション は未認証で読み取り可能。
    // 書き込みは SDK からのみ可能とする。
    match /System/system {
      allow read: if true;
      allow write: if false;
    }

    // --- Rules for 'admin_users' collection ---
    // admin_users コレクション は認証ユーザーであれば許可
    match /admin_users/{uid} {
      allow read, write: if isAuthenticated();
    }

    // --- Rules for 'Companies' collection ---
    // CompaniesコレクションのドキュメントID (companyDocId) と
    // 認証ユーザーのカスタムクレーム companyId が一致する場合のみ許可。
    // または、ユーザーがスーパーユーザーの場合も許可。
    match /Companies/{companyDocId} {
      allow read, write: if (isAuthenticated() && userCompanyId() == companyDocId)
                              || isSuperUser();
    }

    // --- Rules for 'ArrangementNotifications' subcollection under 'Companies' ---
    // ArrangementNotificationsコレクションはCompaniesコレクションのサブコレクション。
    // 認証ユーザーの companyId と一致する Companies ドキュメント配下の
    // ArrangementNotifications ドキュメントのみ Read/Write を許可。
    // または、ユーザーがスーパーユーザーの場合も許可。
    match /Companies/{companyId}/ArrangementNotifications/{id} {
      allow read, write: if (isAuthenticated() && userCompanyId() == companyId)
                              || isSuperUser();
    }

    // --- Rules for 'Autonumbers' subcollection under 'Companies' ---
    // AutonumbersコレクションはCompaniesコレクションのサブコレクション。
    // 認証ユーザーの companyId と一致する Companies ドキュメント配下の
    // Autonumbers ドキュメントのみ Read/Write を許可。
    // または、ユーザーがスーパーユーザーの場合も許可。
    match /Companies/{companyId}/Autonumbers/{id} {
      allow read, write: if (isAuthenticated() && userCompanyId() == companyId)
                              || isSuperUser();
    }

    // --- Rules for 'Billings' subcollection under 'Companies' ---
    // BillingsコレクションはCompaniesコレクションのサブコレクション。
    // 認証ユーザーの companyId と一致する Companies ドキュメント配下の
    // Billings ドキュメントのみ Read/Write を許可。
    // または、ユーザーがスーパーユーザーの場合も許可。
    match /Companies/{companyId}/Billings/{docId} {
      allow read, write: if (isAuthenticated() && userCompanyId() == companyId)
                              || isSuperUser();
    }

    // --- Rules for 'Customers' subcollection under 'Companies' ---
    // CustomersコレクションはCompaniesコレクションのサブコレクション。
    // 認証ユーザーの companyId と一致する Companies ドキュメント配下の
    // Customers ドキュメントのみ Read/Write を許可。
    // または、ユーザーがスーパーユーザーの場合も許可。
    match /Companies/{companyId}/Customers/{docId} {
      allow read, write: if (isAuthenticated() && userCompanyId() == companyId)
                              || isSuperUser();
    }

    // --- Rules for 'Customers_archive' subcollection under 'Companies' ---
    // Customers_archiveコレクションはCompaniesコレクションのサブコレクション。
    // 認証ユーザーの companyId と一致する Companies ドキュメント配下の
    // Customers_archive ドキュメントのみ Read/Write を許可。
    // または、ユーザーがスーパーユーザーの場合も許可。
    match /Companies/{companyId}/Customers_archive/{docId} {
      allow read, write: if (isAuthenticated() && userCompanyId() == companyId)
                              || isSuperUser();
    }

    // --- Rules for 'Employees' subcollection under 'Companies' ---
    // EmployeesコレクションはCompaniesコレクションのサブコレクション。
    // 認証ユーザーの companyId と一致する Companies ドキュメント配下の
    // Employees ドキュメントのみ Read/Write を許可。
    // または、ユーザーがスーパーユーザーの場合も許可。
    match /Companies/{companyId}/Employees/{docId} {
      allow read, write: if (isAuthenticated() && userCompanyId() == companyId)
                              || isSuperUser();
    }

    // --- Rules for 'Employees_archive' subcollection under 'Companies' ---
    // Employees_archiveコレクションはCompaniesコレクションのサブコレクション。
    // 認証ユーザーの companyId と一致する Companies ドキュメント配下の
    // Employees_archive ドキュメントのみ Read/Write を許可。
    // または、ユーザーがスーパーユーザーの場合も許可。
    match /Companies/{companyId}/Employees_archive/{docId} {
      allow read, write: if (isAuthenticated() && userCompanyId() == companyId)
                              || isSuperUser();
    }

    // --- Rules for 'mets' subcollection under 'Companies' ---
    // metaコレクションはCompaniesコレクションのサブコレクション。
    // 認証ユーザーの companyId と一致する Companies ドキュメント配下の
    // meta ドキュメントのみ Read/Write を許可。
    // または、ユーザーがスーパーユーザーの場合も許可。
    match /Companies/{companyId}/meta/{docId} {
      allow read, write: if (isAuthenticated() && userCompanyId() == companyId)
                              || isSuperUser();
    }

    // --- Rules for 'OperationResults' subcollection under 'Companies' ---
    // OperationResultsコレクションはCompaniesコレクションのサブコレクション。
    // 認証ユーザーの companyId と一致する Companies ドキュメント配下の
    // OperationResults ドキュメントのみ Read/Write を許可。
    // または、ユーザーがスーパーユーザーの場合も許可。
    match /Companies/{companyId}/OperationResults/{docId} {
      allow read, write: if (isAuthenticated() && userCompanyId() == companyId)
                              || isSuperUser();
    }

    // --- Rules for 'Outsourcers' subcollection under 'Companies' ---
    // OutsourcersコレクションはCompaniesコレクションのサブコレクション。
    // 認証ユーザーの companyId と一致する Companies ドキュメント配下の
    // Outsourcers ドキュメントのみ Read/Write を許可。
    // または、ユーザーがスーパーユーザーの場合も許可。
    match /Companies/{companyId}/Outsourcers/{docId} {
      allow read, write: if (isAuthenticated() && userCompanyId() == companyId)
                              || isSuperUser();
    }

    // --- Rules for 'Outsourcers_archive' subcollection under 'Companies' ---
    // Outsourcers_archiveコレクションはCompaniesコレクションのサブコレクション。
    // 認証ユーザーの companyId と一致する Companies ドキュメント配下の
    // Outsourcers ドキュメントのみ Read/Write を許可。
    // または、ユーザーがスーパーユーザーの場合も許可。
    match /Companies/{companyId}/Outsourcers_archive/{docId} {
      allow read, write: if (isAuthenticated() && userCompanyId() == companyId)
                              || isSuperUser();
    }

    // --- Rules for 'Sites' subcollection under 'Companies' ---
    // SitesコレクションはCompaniesコレクションのサブコレクション。
    // 認証ユーザーの companyId と一致する Companies ドキュメント配下の
    // Sites ドキュメントのみ Read/Write を許可。
    // または、ユーザーがスーパーユーザーの場合も許可。
    match /Companies/{companyId}/Sites/{docId} {
      allow read, write: if (isAuthenticated() && userCompanyId() == companyId)
                              || isSuperUser();
    }

    // --- Rules for 'Sites_archive' subcollection under 'Companies' ---
    // Sites_archiveコレクションはCompaniesコレクションのサブコレクション。
    // 認証ユーザーの companyId と一致する Companies ドキュメント配下の
    // Sites_archive ドキュメントのみ Read/Write を許可。
    // または、ユーザーがスーパーユーザーの場合も許可。
    match /Companies/{companyId}/Sites_archive/{docId} {
      allow read, write: if (isAuthenticated() && userCompanyId() == companyId)
                              || isSuperUser();
    }

    // --- Rules for 'SiteOperationSchedules' subcollection under 'Companies' ---
    // SiteOperationSchedulesコレクションはCompaniesコレクションのサブコレクション。
    // 認証ユーザーの companyId と一致する Companies ドキュメント配下の
    // SiteOperationSchedules ドキュメントのみ Read/Write を許可。
    // または、ユーザーがスーパーユーザーの場合も許可。
    match /Companies/{companyId}/SiteOperationSchedules/{docId} {
      allow read, write: if (isAuthenticated() && userCompanyId() == companyId)
                              || isSuperUser();
    }

    // Companies/{companyId}/StripeData/{docId}
    match /Companies/{companyId}/StripeData/{docId} {
      // 同じ会社のユーザーのみ読み取り可能
      allow read: if (isAuthenticated() && userCompanyId() == companyId) || isSuperUser();
      
      // 同じ会社のユーザーのみ作成可能（Checkout Session作成用）
      allow create: if (isAuthenticated() && userCompanyId() == companyId) || isSuperUser();
      
      // Cloud Functionsからの書き込みのみ許可（sessionUrl, error更新用）
      // クライアントからの更新・削除は不可
      allow update, delete: if false;
    }

    // --- Rules for 'Users' subcollection under 'Companies' ---
    // UsersコレクションはCompaniesコレクションのサブコレクション。
    // 認証ユーザーの companyId と一致する Companies ドキュメント配下の
    // Users ドキュメントのみ Read/Write を許可。
    // または、ユーザーがスーパーユーザーの場合も許可。
    match /Companies/{companyId}/Users/{userId} {
      allow read, write: if (isAuthenticated() && userCompanyId() == companyId)
                              || isSuperUser();
    }

    // --- General SuperUser Access & Default Deny for Others ---
    // スーパーユーザーはすべてのドキュメントに対して Read/Write アクセスを持つ。
    // このルールは、上記のより具体的なルールでアクセスが許可されなかった場合に評価される。
    // 非スーパーユーザーの場合、上記の具体的なルールにマッチしないパスへのアクセスは、
    // 他に明示的な許可ルールがなければデフォルトで拒否される。
    match /{path=**} {
      allow read, write: if isSuperUser();
    }
  }
}