<script setup>
/**
 * @file ./pages/sites/[id].vue
 * @description 現場情報詳細ページ
 * - ルートパラメータ [id] は Sites コレクションのドキュメント id
 * - ドキュメント id をもとに Site クラスからドキュメント情報を取得して表示
 */
import { reactive, onMounted, computed, onUnmounted, ref, watch } from "vue";
import { useRoute } from "vue-router";
import { Site, Agreement } from "~/schemas";
import { useAuthStore } from "@/stores/useAuthStore";
import { useLogger } from "../composables/useLogger";
import { useErrorsStore } from "@/stores/useErrorsStore";

const { error, clearError } = useLogger("SiteManager", useErrorsStore());

/** define-stores */
const auth = useAuthStore();

const route = useRoute();
const siteId = route.params.id;
const model = reactive(new Site());

const items = computed(() => {
  return [
    {
      title: "CODE",
      props: { subtitle: model.code, prependIcon: "mdi-magnify" },
    },
    {
      title: "住所",
      props: { subtitle: model.fullAddress, prependIcon: "mdi-map-marker" },
    },
    {
      title: "取引先",
      props: {
        subtitle: model.customer?.name || "loading",
        prependIcon: "mdi-domain",
      },
    },
  ];
});

/*****************************************************************************
 * LIFE CYCLE HOOKS
 *****************************************************************************/
onMounted(async () => {
  await model.subscribe({ docId: siteId });
});

onUnmounted(() => {
  model.unsubscribe();
});
</script>
<template>
  <v-container>
    <v-row>
      <v-col>
        <v-card>
          <v-toolbar density="comfortable">
            <v-toolbar-title>{{ model.name }}</v-toolbar-title>
            <v-spacer />
            <air-item-manager
              :model="model"
              :input-props="{
                excludedKeys: ['agreements'],
              }"
              :handle-create="(item) => item.create()"
              :handle-update="(item) => item.update()"
              :handle-delete="(item) => item.delete()"
              @error="error"
              @error:clear="clearError"
            >
            </air-item-manager>
          </v-toolbar>
          <v-list :items="items"> </v-list>
        </v-card>
      </v-col>
      <v-col cols="12">
        <OrganismsSiteOperationSchedulesManager :site-id="siteId" />
      </v-col>
      <v-col>
        <v-card>
          <air-array-manager
            v-model="model.agreements"
            item-key="key"
            :schema="Agreement"
            :dialog-props="{
              maxWidth: 600,
            }"
            :table-props="{
              hideDefaultFooter: true,
              itemsPerPage: -1,
              sortBy: [{ key: 'from', order: 'desc' }],
            }"
            :before-edit="
              (editMode, item) => {
                if (editMode === 'CREATE') item.startTime = '09:00';
              }
            "
            @submit:complete="model.update()"
          >
            <template #input="slotProps">
              <air-item-input v-bind="slotProps">
                <template #after-dateAt="{ field }">
                  <v-col v-bind="field.colsDefinition">
                    <MoleculesAgreementSelector
                      :items="[...model.agreements, ...auth.company.agreements]"
                      @select="
                        $event.dateAt = slotProps.item.dateAt;
                        slotProps.updateProperties({ ...$event });
                      "
                    >
                      <template #activator="{ props: activatorProps }">
                        <v-btn v-bind="activatorProps" block color="primary"
                          >取極めから複製</v-btn
                        >
                      </template>
                    </MoleculesAgreementSelector>
                  </v-col>
                </template>
              </air-item-input>
            </template>
          </air-array-manager>
        </v-card>
      </v-col>
    </v-row>
  </v-container>
</template>
